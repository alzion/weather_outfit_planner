<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather & Outfit Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md rounded-2xl shadow-xl overflow-hidden p-8">
        
        <!-- Help Button (Top Left) -->
        <div class="absolute top-4 left-4">
            <button onclick="toggleHelp()" class="text-slate-400 hover:text-blue-600 transition-colors" title="Help / Info">
                <i class="fa-solid fa-circle-question text-xl"></i>
            </button>
        </div>

        <!-- Language Selector (Top Right) -->
        <div class="absolute top-4 right-4">
            <select id="languageSelect" onchange="changeLanguage()" class="bg-white/50 border border-slate-200 text-slate-600 text-xs rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400 cursor-pointer">
                <option value="en">üá∫üá∏ English</option>
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="kk">üá∞üáø “ö–∞–∑–∞“õ—à–∞</option>
            </select>
        </div>

        <!-- Header -->
        <div class="text-center mb-8 mt-4">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                <i class="fa-solid fa-shirt text-2xl"></i>
            </div>
            <h1 id="ui-title" class="text-2xl font-bold text-slate-800">Outfit Planner</h1>
            <p id="ui-subtitle" class="text-slate-500 text-sm mt-1">Check the weather & know what to wear.</p>
        </div>

        <!-- Input Section -->
        <div class="space-y-4">
            
            <!-- Time Selection -->
            <div class="bg-blue-50/50 p-3 rounded-lg flex flex-wrap items-center justify-center gap-4">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="timeFrame" value="current" checked class="accent-blue-600 w-4 h-4 cursor-pointer">
                    <span id="ui-time-now" class="text-sm text-slate-600 font-medium group-hover:text-blue-600 transition-colors">Right Now</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="timeFrame" value="workday" class="accent-blue-600 w-4 h-4 cursor-pointer">
                    <span id="ui-time-work" class="text-sm text-slate-600 font-medium group-hover:text-blue-600 transition-colors">Workday (9-5)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="timeFrame" value="nightout" class="accent-blue-600 w-4 h-4 cursor-pointer">
                    <span id="ui-time-night" class="text-sm text-slate-600 font-medium group-hover:text-blue-600 transition-colors">Night Out</span>
                </label>
            </div>

            <div>
                <label id="ui-label" for="cityInput" class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Your Location</label>
                <div class="relative">
                    <input type="text" id="cityInput" placeholder="e.g. New York, London, Tokyo" 
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg py-3 px-4 pl-10 pr-12 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <i class="fa-solid fa-location-dot absolute left-4 top-3.5 text-slate-400"></i>
                    
                    <!-- Location Button -->
                    <button onclick="useDeviceLocation()" class="absolute right-3 top-2.5 p-1 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-all" title="Use My Location">
                        <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    </button>
                </div>
            </div>

            <button id="getWeatherBtn" onclick="getRecommendation()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2">
                <span id="ui-btn">Get Advice</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loader" class="hidden mt-6 text-center">
            <div class="loader mx-auto mb-2"></div>
            <p id="ui-loading" class="text-sm text-slate-400 animate-pulse">Checking the forecast...</p>
            <p id="ui-wait-msg" class="text-xs text-slate-300 mt-1">(This might take a few seconds)</p>
        </div>

        <!-- Error / Warning State -->
        <div id="errorMessage" class="hidden mt-6 p-4 rounded-lg text-sm border flex items-start gap-3 transition-colors">
            <i id="errorIcon" class="fa-solid fa-circle-exclamation mt-0.5"></i>
            <span id="errorText">Something went wrong.</span>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden mt-8 border-t border-slate-100 pt-6 animate-fade-in">
            
            <!-- Weather Card -->
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-orange-100 text-orange-500 w-12 h-12 rounded-xl flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-cloud-sun text-xl"></i>
                </div>
                <div>
                    <h3 id="ui-weather-title" class="font-bold text-slate-700">Current Weather</h3>
                    <p id="weatherText" class="text-sm text-slate-500 leading-snug">--</p>
                    <p id="resolvedCityText" class="text-xs text-slate-400 mt-1 italic hidden"></p>
                </div>
            </div>

            <!-- Outfit Card -->
            <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                <div class="flex items-center gap-2 mb-3 text-blue-800 font-semibold">
                    <i class="fa-solid fa-hat-wizard"></i>
                    <h3 id="ui-outfit-title">Outfit Recommendations</h3>
                </div>
                <div id="outfitContainer" class="space-y-3">
                    <!-- Dynamic Content will be injected here -->
                </div>
            </div>
            
            <!-- Sources -->
            <div id="sourcesSection" class="hidden mt-4 text-xs text-slate-400">
                <p id="ui-sources" class="font-semibold mb-1">Sources:</p>
                <ul id="sourcesList" class="list-disc pl-4 space-y-0.5"></ul>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative animate-fade-in">
            <!-- Close X -->
            <button onclick="toggleHelp()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            
            <h2 id="ui-help-title" class="text-xl font-bold text-slate-800 mb-4">How it works</h2>
            
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-sm font-bold">1</div>
                    <p id="ui-help-step1" class="text-sm text-slate-600 leading-snug pt-1">Enter your city or use the location button to find your spot.</p>
                </div>
                <div class="flex gap-3">
                    <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-sm font-bold">2</div>
                    <p id="ui-help-step2" class="text-sm text-slate-600 leading-snug pt-1">Choose when you need the outfit for (Now, Workday, or Night Out).</p>
                </div>
                <div class="flex gap-3">
                    <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-sm font-bold">3</div>
                    <p id="ui-help-step3" class="text-sm text-slate-600 leading-snug pt-1">Get AI-powered advice based on live weather data.</p>
                </div>
            </div>

            <button onclick="toggleHelp()" id="ui-help-close" class="mt-6 w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 rounded-lg transition-colors">
                Got it
            </button>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // Configuration
        // ---------------------------------------------------------
        const apiKey = '/api/weather'; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // ---------------------------------------------------------
        // Localization
        // ---------------------------------------------------------
        const translations = {
            en: {
                title: "Outfit Planner",
                subtitle: "Check the weather & know what to wear.",
                label: "Your Location",
                placeholder: "e.g. New York, London, Tokyo",
                btn: "Get Advice",
                loading: "Checking the forecast...",
                waitMsg: "(This might take a few seconds)",
                weatherTitle: "Weather Conditions",
                outfitTitle: "Outfit Recommendations",
                sources: "Sources:",
                promptLang: "English",
                emptyCity: "Please enter a city name.",
                sampleWarning: "We couldn't find that location. Showing sample data for London instead.",
                correctedPrefix: "Weather for: ",
                locating: "Locating...",
                geoError: "Unable to retrieve location.",
                geoPermission: "Location permission denied.",
                timeNow: "Right Now",
                timeWork: "Workday (9-5)",
                timeNight: "Night Out",
                // Help Modal
                helpTitle: "How it works",
                helpStep1: "Enter your city or use the location button to find your spot.",
                helpStep2: "Choose when you need the outfit for (Now, Workday, or Night Out).",
                helpStep3: "Get AI-powered advice based on live weather data.",
                helpClose: "Got it"
            },
            ru: {
                title: "–ì–∞—Ä–¥–µ—Ä–æ–±",
                subtitle: "–£–∑–Ω–∞–π –ø–æ–≥–æ–¥—É –∏ —á—Ç–æ –Ω–∞–¥–µ—Ç—å.",
                label: "–í–∞—à –≥–æ—Ä–æ–¥",
                placeholder: "–Ω–∞–ø—Ä. –ú–æ—Å–∫–≤–∞, –ê–ª–º–∞—Ç—ã, –ù—å—é-–ô–æ—Ä–∫",
                btn: "–ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç",
                loading: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≥–æ–¥—É...",
                waitMsg: "(–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥)",
                weatherTitle: "–ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è",
                outfitTitle: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
                sources: "–ò—Å—Ç–æ—á–Ω–∏–∫–∏:",
                promptLang: "Russian",
                emptyCity: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.",
                sampleWarning: "–ú—ã –Ω–µ –Ω–∞—à–ª–∏ —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–ª—è –õ–æ–Ω–¥–æ–Ω–∞.",
                correctedPrefix: "–ü–æ–≥–æ–¥–∞ –¥–ª—è: ",
                locating: "–ò—â–µ–º...",
                geoError: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.",
                geoPermission: "–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω.",
                timeNow: "–°–µ–π—á–∞—Å",
                timeWork: "–†–∞–±–æ—á–∏–π –¥–µ–Ω—å (9-5)",
                timeNight: "–í–µ—á–µ—Ä–Ω–∏–π –≤—ã—Ö–æ–¥",
                // Help Modal
                helpTitle: "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç",
                helpStep1: "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.",
                helpStep2: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è (–°–µ–π—á–∞—Å, –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –∏–ª–∏ –í–µ—á–µ—Ä).",
                helpStep3: "–ü–æ–ª—É—á–∏—Ç–µ —Å–æ–≤–µ—Ç –æ—Ç –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã.",
                helpClose: "–ü–æ–Ω—è—Ç–Ω–æ"
            },
            kk: {
                title: "–ö–∏—ñ–º —Ç–∞“£–¥–∞—É",
                subtitle: "–ê—É–∞ —Ä–∞–π—ã–Ω –±—ñ–ª—ñ–ø, –∫–∏—ñ–º —Ç–∞“£–¥–∞“£—ã–∑.",
                label: "–°—ñ–∑–¥—ñ“£ “õ–∞–ª–∞“£—ã–∑",
                placeholder: "–º—ã—Å. –ê—Å—Ç–∞–Ω–∞, –ê–ª–º–∞—Ç—ã, –õ–æ–Ω–¥–æ–Ω",
                btn: "–ö–µ“£–µ—Å –∞–ª—É",
                loading: "–ë–æ–ª–∂–∞–º —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...",
                waitMsg: "(–ë—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥ –∫“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑)",
                weatherTitle: "–ê—É–∞ —Ä–∞–π—ã –∂–∞“ì–¥–∞–π—ã",
                outfitTitle: "–ö–∏—ñ–º “±—Å—ã–Ω—ã—Å—Ç–∞—Ä—ã",
                sources: "–î–µ—Ä–µ–∫–∫”©–∑–¥–µ—Ä:",
                promptLang: "Kazakh",
                emptyCity: "“ö–∞–ª–∞–Ω—ã“£ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.",
                sampleWarning: "–ë“±–ª “õ–∞–ª–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã. –õ–æ–Ω–¥–æ–Ω “Ø—à—ñ–Ω “Ø–ª–≥—ñ –¥–µ—Ä–µ–∫—Ç–µ—Ä –∫”©—Ä—Å–µ—Ç—ñ–ª—É–¥–µ.",
                correctedPrefix: "–ê—É–∞ —Ä–∞–π—ã: ",
                locating: "–Ü–∑–¥–µ—É–¥–µ...",
                geoError: "–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä–¥—ñ –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
                geoPermission: "–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—É“ì–∞ —Ä“±“õ—Å–∞—Ç –∂–æ“õ.",
                timeNow: "“ö–∞–∑—ñ—Ä",
                timeWork: "–ñ“±–º—ã—Å –∫“Ø–Ω—ñ (9-5)",
                timeNight: "–ö–µ—à–∫—ñ —Å–µ—Ä—É–µ–Ω",
                // Help Modal
                helpTitle: "“ö–∞–ª–∞–π –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ",
                helpStep1: "“ö–∞–ª–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è–Ω—ã “õ–æ–ª–¥–∞–Ω—ã“£—ã–∑.",
                helpStep2: "–£–∞“õ—ã—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑ (“ö–∞–∑—ñ—Ä, –ñ“±–º—ã—Å –∫“Ø–Ω—ñ –Ω–µ–º–µ—Å–µ –ö–µ—à–∫—ñ —Å–µ—Ä—É–µ–Ω).",
                helpStep3: "–ê—É–∞ —Ä–∞–π—ã–Ω–∞ –Ω–µ–≥—ñ–∑–¥–µ–ª–≥–µ–Ω –ò–ò –∫–µ“£–µ—Å—ñ–Ω –∞–ª—ã“£—ã–∑.",
                helpClose: "–¢“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ"
            }
        };

        let currentLang = 'en';

        // ---------------------------------------------------------
        // Auto-Detect Language
        // ---------------------------------------------------------
        function detectSystemLanguage() {
            const browserLang = navigator.language || navigator.userLanguage; 
            // Check if language starts with supported codes (e.g., "ru-RU" -> "ru")
            if (browserLang.startsWith('ru')) {
                currentLang = 'ru';
            } else if (browserLang.startsWith('kk')) {
                currentLang = 'kk';
            } else {
                currentLang = 'en';
            }
            
            // Update the dropdown to match
            const selector = document.getElementById('languageSelect');
            if(selector) {
                selector.value = currentLang;
            }

            // Apply the language
            changeLanguage();
        }

        function changeLanguage() {
            // If called via dropdown change, update currentLang
            const selector = document.getElementById('languageSelect');
            if (selector) {
                currentLang = selector.value;
            }
            
            const t = translations[currentLang];

            document.getElementById('ui-title').textContent = t.title;
            document.getElementById('ui-subtitle').textContent = t.subtitle;
            document.getElementById('ui-label').textContent = t.label;
            document.getElementById('cityInput').placeholder = t.placeholder;
            document.getElementById('ui-btn').textContent = t.btn;
            document.getElementById('ui-loading').textContent = t.loading;
            document.getElementById('ui-wait-msg').textContent = t.waitMsg;
            document.getElementById('ui-weather-title').textContent = t.weatherTitle;
            document.getElementById('ui-outfit-title').textContent = t.outfitTitle;
            document.getElementById('ui-sources').textContent = t.sources;
            
            document.getElementById('ui-time-now').textContent = t.timeNow;
            document.getElementById('ui-time-work').textContent = t.timeWork;
            document.getElementById('ui-time-night').textContent = t.timeNight;

            // Help Modal Translations
            document.getElementById('ui-help-title').textContent = t.helpTitle;
            document.getElementById('ui-help-step1').textContent = t.helpStep1;
            document.getElementById('ui-help-step2').textContent = t.helpStep2;
            document.getElementById('ui-help-step3').textContent = t.helpStep3;
            document.getElementById('ui-help-close').textContent = t.helpClose;
        }

        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('hidden');
        }

        // ---------------------------------------------------------
        // Location Logic
        // ---------------------------------------------------------
        function useDeviceLocation() {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.", 'error');
                return;
            }

            const t = translations[currentLang];
            const input = document.getElementById('cityInput');
            const originalPlaceholder = input.placeholder;
            
            // Set Loading UI
            input.value = "";
            input.placeholder = t.locating;
            input.disabled = true;
            hideError();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(4);
                    const lon = position.coords.longitude.toFixed(4);
                    
                    // Input coordinates nicely
                    input.value = `${lat}, ${lon}`;
                    input.disabled = false;
                    input.placeholder = originalPlaceholder;
                    
                    // Auto-trigger search
                    getRecommendation();
                },
                (error) => {
                    input.disabled = false;
                    input.placeholder = originalPlaceholder;
                    let msg = t.geoError;
                    if (error.code === error.PERMISSION_DENIED) {
                        msg = t.geoPermission;
                    }
                    showError(msg, 'error');
                }
            );
        }

        // ---------------------------------------------------------
        // Core Logic
        // ---------------------------------------------------------
        
        async function getRecommendation() {
            const cityInput = document.getElementById('cityInput').value.trim();
            const t = translations[currentLang];
            
            // Get selected time frame
            const timeFrameValue = document.querySelector('input[name="timeFrame"]:checked').value;
            let timePrompt = '';
            
            // Logic for new timeframes with 11 AM cutoff for Workday
            if (timeFrameValue === 'workday') {
                const currentHour = new Date().getHours();
                if (currentHour < 11) {
                    timePrompt = 'today during working hours (remaining time until 5 PM). If today is a weekend, provide advice for the next business day (Monday). Focus on office-appropriate wear.';
                } else {
                    timePrompt = 'the next business day (typically Mon-Fri) during working hours (9 AM - 5 PM). Focus on office-appropriate wear for the entire day.';
                }
            } else if (timeFrameValue === 'nightout') {
                timePrompt = 'this evening or tonight. Focus on social/night-out attire';
            } else {
                timePrompt = 'current (right now)';
            }

            if (!cityInput) {
                showError(t.emptyCity, 'error');
                return;
            }

            // UI Reset
            hideError();
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('getWeatherBtn').disabled = true;
            document.getElementById('getWeatherBtn').classList.add('opacity-70');
            document.getElementById('resolvedCityText').classList.add('hidden');

            try {
                // Get current date string to help the AI anchor "today" vs "tomorrow"
                const nowString = new Date().toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' });

                // UPDATED PROMPT: Added Current Time context and explicit 11am logic instruction
                const prompt = `
                    You are a weather assistant. 
                    Current System Time: ${nowString}.
                    The user input is: "${cityInput}".
                    The user wants to know the weather for: **${timePrompt}**.
                    
                    Step 1: Analyze the input.
                    - If it is coordinates (lat, lon), find the weather for that exact location and the name of the nearest city/area.
                    - If it looks like a typo, assume the nearest valid city.
                    - If the input is unrecognizable, set "is_sample" to true and generate sample data for London.

                    Step 2: Generate Response in ${t.promptLang}.
                    
                    Return a JSON object with this structure:
                    {
                        "resolved_city_name": "The actual city name/area",
                        "is_sample": boolean, 
                        "weather_summary": "A short sentence describing the requested weather (temperature & conditions) in ${t.promptLang}. IMPORTANT: You MUST include the specific target Date (e.g., 'Monday, Nov 24') in this summary.",
                        "outfits": [
                            { "style": "Option 1", "suggestion": "Suggestion in ${t.promptLang}..." },
                            { "style": "Option 2", "suggestion": "Suggestion in ${t.promptLang}..." },
                            { "style": "Option 3", "suggestion": "Suggestion in ${t.promptLang}..." }
                        ],
                        "icon_hint": "sun|rain|cloud|snow|wind|moon" 
                    }
                    
                    Do not include markdown code blocks, just the raw JSON string.
                `;

                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    tools: [{ "google_search": {} }] 
                };

                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Extract Text
                const candidate = data.candidates?.[0];
                const rawText = candidate?.content?.parts?.[0]?.text;
                
                if (!rawText) throw new Error("No advice generated.");

                const cleanJson = rawText.replace(/```json|```/g, '').trim();
                let adviceData;
                
                try {
                    adviceData = JSON.parse(cleanJson);
                } catch (e) {
                    adviceData = {
                        resolved_city_name: cityInput,
                        is_sample: true,
                        weather_summary: "Sample Weather: 20¬∞C Sunny",
                        outfits: [{ style: "Error Fallback", suggestion: rawText }],
                        icon_hint: "cloud"
                    };
                }

                // Extract Grounding Metadata
                const groundingChunks = candidate.groundingMetadata?.groundingAttributions || [];
                const sources = groundingChunks.map(chunk => ({
                    title: chunk.web?.title || "Source",
                    uri: chunk.web?.uri || "#"
                })).filter(s => s.uri !== "#");

                renderResult(adviceData, sources);

            } catch (error) {
                console.error(error);
                // Even on API failure, we can show a hardcoded sample if we wanted, 
                // but here we show a network error.
                showError("Could not connect to weather service. Please try again.", 'error');
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('getWeatherBtn').disabled = false;
                document.getElementById('getWeatherBtn').classList.remove('opacity-70');
            }
        }

        // ---------------------------------------------------------
        // Helper Functions
        // ---------------------------------------------------------

        async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                return response;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        function renderResult(data, sources) {
            const section = document.getElementById('resultSection');
            const weatherText = document.getElementById('weatherText');
            const outfitContainer = document.getElementById('outfitContainer');
            const sourcesSection = document.getElementById('sourcesSection');
            const sourcesList = document.getElementById('sourcesList');
            const resolvedCityText = document.getElementById('resolvedCityText');
            const t = translations[currentLang];

            // 1. Check for Sample Data
            if (data.is_sample) {
                showError(t.sampleWarning, 'warning');
            } else {
                hideError();
            }

            // 2. Show Resolved City Name if it differs or just to be clear
            if (data.resolved_city_name) {
                resolvedCityText.textContent = `${t.correctedPrefix} ${data.resolved_city_name}`;
                resolvedCityText.classList.remove('hidden');
            }

            // 3. Update Weather Text
            weatherText.textContent = data.weather_summary;
            
            // 4. Update Outfits
            outfitContainer.innerHTML = ''; 
            
            const outfits = Array.isArray(data.outfits) ? data.outfits : [{ style: "Recommendation", suggestion: data.outfit_advice || "No advice available." }];

            outfits.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-lg border border-blue-100 shadow-sm";
                div.innerHTML = `
                    <div class="text-xs font-bold text-blue-500 uppercase tracking-wide mb-1">${item.style}</div>
                    <div class="text-slate-700 text-sm leading-relaxed">${item.suggestion}</div>
                `;
                outfitContainer.appendChild(div);
            });

            // 5. Update Icon
            const iconMap = {
                'sun': 'fa-sun',
                'rain': 'fa-cloud-showers-heavy',
                'cloud': 'fa-cloud',
                'snow': 'fa-snowflake',
                'wind': 'fa-wind',
                'moon': 'fa-moon'
            };
            const iconClass = iconMap[data.icon_hint] || 'fa-cloud-sun';
            const iconContainer = document.querySelector('.bg-orange-100 i');
            iconContainer.className = `fa-solid ${iconClass} text-xl`;

            // 6. Handle Sources
            sourcesList.innerHTML = '';
            if (sources.length > 0 && !data.is_sample) {
                sourcesSection.classList.remove('hidden');
                sources.forEach(src => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = src.uri;
                    a.target = "_blank";
                    a.textContent = src.title;
                    a.className = "hover:text-blue-500 underline decoration-dotted";
                    li.appendChild(a);
                    sourcesList.appendChild(li);
                });
            } else {
                sourcesSection.classList.add('hidden');
            }

            section.classList.remove('hidden');
        }

        function showError(msg, type) {
            const errDiv = document.getElementById('errorMessage');
            const errText = document.getElementById('errorText');
            const errIcon = document.getElementById('errorIcon');
            
            errText.innerText = msg;
            errDiv.classList.remove('hidden');

            // Style based on type
            if (type === 'warning') {
                errDiv.className = "mt-6 bg-yellow-50 text-yellow-700 p-4 rounded-lg text-sm border border-yellow-200 flex items-start gap-3 transition-colors";
                errIcon.className = "fa-solid fa-triangle-exclamation mt-0.5";
            } else {
                // Default error red
                errDiv.className = "mt-6 bg-red-50 text-red-600 p-4 rounded-lg text-sm border border-red-100 flex items-start gap-3 transition-colors";
                errIcon.className = "fa-solid fa-circle-exclamation mt-0.5";
            }
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        document.getElementById('cityInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                getRecommendation();
            }
        });

        // Initialize Language on Load
        detectSystemLanguage();
    </script>
</body>
</html>
